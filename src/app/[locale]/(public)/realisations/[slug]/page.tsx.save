n



import { Metadata } from "next";
import Link from "next/link";
import { notFound } from "next/navigation";
import { prisma } from "@/lib/prisma";
import {
  getLocalizedText,
  type SupportedLocale,
} from "@/lib/localization";
import { ArrowLeft, MapPin, Calendar, Clock, User, Tag } from "lucide-react";
import HeroSlideshow from "@/components/public/HeroSlideshow";
import ImageSliderGallery from "@/components/public/ImageSliderGallery";
import { ThemeWrapper, CtaSection } from "./ThemeWrapper";

// ═══════════════════════════════════════════════════════════════════════════════
// TYPES
// ═══════════════════════════════════════════════════════════════════════════════

interface PageProps {
  params: Promise<{ locale: string; slug: string }>;
}

// ═══════════════════════════════════════════════════════════════════════════════
// TRANSLATIONS
// ═══════════════════════════════════════════════════════════════════════════════

const translations = {
  back: {
    fr: "Retour aux réalisations",
    en: "Back to portfolio",
    es: "Volver al portafolio",
    ar: "العودة إلى الإنجازات",
  },
  before: {
    fr: "Avant - Travaux",
    en: "Before - Work in Progress",
    es: "Antes - Trabajos",
    ar: "قبل - الأعمال",
  },
  after: {
    fr: "Après - Résultat final",
    en: "After - Final Result",
    es: "Después - Resultado final",
    ar: "بعد - النتيجة النهائية",
  },
  location: {
    fr: "Lieu",
    en: "Location",
    es: "Ubicación",
    ar: "الموقع",
  },
  year: {
    fr: "Année",
    en: "Year",
    es: "Año",
    ar: "السنة",
  },
  duration: {
    fr: "Durée",
    en: "Duration",
    es: "Duración",
    ar: "المدة",
  },
  client: {
    fr: "Client",
    en: "Client",
    es: "Cliente",
    ar: "العميل",
  },
  category: {
    fr: "Catégorie",
    en: "Category",
    es: "Categoría",
    ar: "الفئة",
  },
  requestQuote: {
    fr: "Demander un devis",
    en: "Request a quote",
    es: "Solicitar cotización",
    ar: "طلب عرض أسعار",
  },
  similarProject: {
    fr: "Vous avez un projet similaire ?",
    en: "Have a similar project?",
    es: "¿Tiene un proyecto similar?",
    ar: "هل لديك مشروع مشابه؟",
  },
  contactUs: {
    fr: "Contactez-nous pour discuter de votre projet et obtenir un devis gratuit.",
    en: "Contact us to discuss your project and get a free quote.",
    es: "Contáctenos para discutir su proyecto y obtener un presupuesto gratuito.",
    ar: "اتصل بنا لمناقشة مشروعك والحصول على عرض أسعار مجاني.",
  },
  phase1: {
    fr: "Phase 1",
    en: "Phase 1",
    es: "Fase 1",
    ar: "المرحلة 1",
  },
  finalResult: {
    fr: "Résultat Final",
    en: "Final Result",
    es: "Resultado Final",
    ar: "النتيجة النهائية",
  },
  workDescription: {
    fr: "Description des travaux",
    en: "Work Description",
    es: "Descripción de los trabajos",
    ar: "وصف الأعمال",
  },
  completedWork: {
    fr: "Travaux réalisés",
    en: "Completed Work",
    es: "Trabajos realizados",
    ar: "الأعمال المنجزة",
  },
};

// ═══════════════════════════════════════════════════════════════════════════════
// METADATA
// ═══════════════════════════════════════════════════════════════════════════════

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { locale, slug } = await params;

  try {
    const project = await prisma.portfolioProject.findUnique({
      where: { slug },
    });

    if (!project) {
      return { title: "Project Not Found" };
    }

    const loc = locale as SupportedLocale;
    const title = getLocalizedText(
      { fr: project.titleFr ?? "", en: project.titleEn ?? "", es: project.titleEs ?? "", ar: project.titleAr ?? "" },
      loc
    );
    const description = getLocalizedText(
      { fr: project.descriptionFr ?? "", en: project.descriptionEn ?? "", es: project.descriptionEs ?? "", ar: project.descriptionAr ?? "" },
      loc
    );

    return {
      title: title || "Project",
      description: description || title || "Portfolio project",
      openGraph: {
        images: project.coverImage ? [project.coverImage] : [],
      },
    };
  } catch {
    return { title: "Project Not Found" };
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// PAGE COMPONENT
// ═══════════════════════════════════════════════════════════════════════════════

export default async function PortfolioDetailPage({ params }: PageProps) {
  const { locale, slug } = await params;
  const loc = (locale as SupportedLocale) || "fr";

  // Fetch project from database
  let project;
  try {
    project = await prisma.portfolioProject.findUnique({
      where: { slug },
      include: { category: true },
    });
  } catch (error) {
    console.error("Error fetching project:", error);
    notFound();
  }

  if (!project || !project.isActive) {
    notFound();
  }

  // Get localized content
  const title = getLocalizedText(
    { fr: project.titleFr ?? "", en: project.titleEn ?? "", es: project.titleEs ?? "", ar: project.titleAr ?? "" },
    loc
  );
  const description = getLocalizedText(
    { fr: project.descriptionFr ?? "", en: project.descriptionEn ?? "", es: project.descriptionEs ?? "", ar: project.descriptionAr ?? "" },
    loc
  );
  const beforeDesc = getLocalizedText(
    { fr: project.beforeDescFr ?? "", en: project.beforeDescEn ?? "", es: project.beforeDescEs ?? "", ar: project.beforeDescAr ?? "" },
    loc
  );
  const afterDesc = getLocalizedText(
    { fr: project.afterDescFr ?? "", en: project.afterDescEn ?? "", es: project.afterDescEs ?? "", ar: project.afterDescAr ?? "" },
    loc
  );

  const categoryName = project.category
    ? getLocalizedText(
        {
          fr: project.category.nameFr,
          en: project.category.nameEn,
          es: project.category.nameEs,
          ar: project.category.nameAr,
        },
        loc
      )
    : null;

  // Combine ALL images for hero slideshow (3 second auto-rotate)
  const allHeroImages: string[] = [
    project.coverImage,
    ...(project.beforeImages || []),
    ...(project.afterImages || []),
    ...(project.images || []),
  ].filter((img): img is string => !!img && img.trim() !== '');

  const t = (key: keyof typeof translations) => translations[key][loc] || translations[key].fr;

  return (
    <ThemeWrapper>
      {/* ═══════════════════════════════════════════════════════════════════ */}
      {/* HERO SLIDESHOW - All images animated (3 seconds) */}
      {/* ═══════════════════════════════════════════════════════════════════ */}
      <HeroSlideshow images={allHeroImages} interval={3000}>
        <div className="container mx-auto px-4 pb-12">
          <Link
            href={`/${locale}/realisations`}
            className="inline-flex items-center gap-2 text-white/80 hover:text-white mb-4 transition-colors"
          >
            <ArrowLeft className="w-4 h-4" />
            {t("back")}
          </Link>

          {project.category && (
            <span className="inline-block px-4 py-1.5 bg-amber-500 text-white rounded-full text-sm font-semibold mb-4 ml-3">
              {project.category.icon} {categoryName}
            </span>
          )}

          <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold text-white">
            {title}
          </h1>
        </div>
      </HeroSlideshow>

      {/* ═══════════════════════════════════════════════════════════════════ */}
      {/* DESCRIPTION + PROJECT DETAILS (After Hero) */}
      {/* ═══════════════════════════════════════════════════════════════════ */}
      <section className="py-8 md:py-12">
        <div className="container mx-auto px-3 md:px-4">
          <div className="max-w-5xl mx-auto bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/60 p-5 md:p-10">
            {/* Description */}
            {description && (
              <p className="text-base md:text-xl text-stone-700 leading-relaxed text-center mb-6 md:mb-8">
                {description}
              </p>
            )}

            {/* Divider */}
            <hr className="border-amber-200/60 mb-6 md:mb-8" />

            {/* Project Details - Horizontal */}
            <div className="flex flex-wrap items-center justify-center gap-x-6 gap-y-3 md:gap-x-8 md:gap-y-4">
              {project.location && (
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 bg-amber-100/80 rounded-full flex items-center justify-center">
                    <MapPin className="w-5 h-5 text-amber-700" />
                  </div>
                  <div>
                    <p className="text-xs text-stone-500 uppercase tracking-wide">{t("location")}</p>
                    <p className="font-semibold text-stone-800">{project.location}</p>
                  </div>
                </div>
              )}

              {project.year && (
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 bg-amber-100/80 rounded-full flex items-center justify-center">
                    <Calendar className="w-5 h-5 text-amber-700" />
                  </div>
                  <div>
                    <p className="text-xs text-stone-500 uppercase tracking-wide">{t("year")}</p>
                    <p className="font-semibold text-stone-800">{project.year}</p>
                  </div>
                </div>
              )}

              {project.duration && (
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 bg-amber-100/80 rounded-full flex items-center justify-center">
                    <Clock className="w-5 h-5 text-amber-700" />
                  </div>
                  <div>
                    <p className="text-xs text-stone-500 uppercase tracking-wide">{t("duration")}</p>
                    <p className="font-semibold text-stone-800">{project.duration}</p>
                  </div>
                </div>
              )}

              {project.client && (
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 bg-amber-100/80 rounded-full flex items-center justify-center">
                    <User className="w-5 h-5 text-amber-700" />
                  </div>
                  <div>
                    <p className="text-xs text-stone-500 uppercase tracking-wide">{t("client")}</p>
                    <p className="font-semibold text-stone-800">{project.client}</p>
                  </div>
                </div>
              )}

              {project.category && (
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 bg-amber-100/80 rounded-full flex items-center justify-center">
                    <Tag className="w-5 h-5 text-amber-700" />
                  </div>
                  <div>
                    <p className="text-xs text-stone-500 uppercase tracking-wide">{t("category")}</p>
                    <p className="font-semibold text-stone-800">{project.category.icon} {categoryName}</p>
                  </div>
                </div>
              )}
            </div>

            {/* CTA Button */}
            <div className="text-center mt-8">
              <Link
                href={`/${locale}/devis`}
                className="inline-block px-8 py-3 bg-amber-700 text-white font-semibold rounded-xl hover:bg-amber-800 transition-colors shadow-lg"
              >
                {t("requestQuote")}
              </Link>
            </div>
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════ */}
      {/* AVANT (BEFORE) SECTION */}
      {/* ═══════════════════════════════════════════════════════════════════ */}
      {(project.beforeImages && project.beforeImages.length > 0 || beforeDesc) && (
        <section className="py-6 md:py-16">
          <div className="container mx-auto px-2 md:px-4">
            <div className="max-w-6xl mx-auto bg-white/90 backdrop-blur-sm rounded-xl md:rounded-2xl shadow-xl border border-white/60 overflow-hidden">

              {/* Section Header */}
              <div className="relative px-4 pt-4 pb-2 md:px-10 md:pt-10 md:pb-4">
                <div className="absolute left-2 md:left-4 top-4 bottom-2 w-1 bg-gradient-to-b from-amber-600 to-amber-400 rounded-full" />

                <div className="pl-4 md:pl-6">
                  {/* Badge */}
                  <div className="inline-flex items-center gap-2 px-3 py-1.5 md:px-4 md:py-2 bg-amber-50 border border-amber-200 rounded-full mb-2 md:mb-4">
                    <div className="w-2.5 h-2.5 md:w-3 md:h-3 bg-amber-500 rounded-full animate-pulse" />
                    <span className="text-amber-800 font-semibold text-xs md:text-sm uppercase tracking-wider">
                      {t("phase1")}
                    </span>
                  </div>

                  {/* Title */}
                  <h2 className="text-xl md:text-4xl font-bold text-stone-800 mb-1">
                    <span className="text-amber-700">{t("before").split(' - ')[0]}</span>
                    {t("before").includes(' - ') && (
                      <span className="text-stone-400 font-normal"> — {t("before").split(' - ')[1]}</span>
                    )}
                  </h2>

                  {/* Decorative line */}
                  <div className="flex items-center gap-2 mt-2 md:mt-4">
                    <div className="h-1 w-12 md:w-16 bg-amber-600 rounded-full" />
                    <div className="h-1 w-6 md:w-8 bg-amber-400 rounded-full" />
                    <div className="h-1 w-3 md:w-4 bg-amber-300 rounded-full" />
                  </div>
                </div>
              </div>

              {/* Image Slider — FIRST, near full-width on mobile */}
              {project.beforeImages && project.beforeImages.length > 0 && (
                <div className="px-1 py-2 md:px-8 md:py-6">
                  <ImageSliderGallery
                    images={project.beforeImages}
                    title={`${title} - ${t("before")}`}
                  />
                </div>
              )}

              {/* Description Card — below images */}
              {beforeDesc && (
                <div className="mx-3 mb-4 md:mx-10 md:mb-10 bg-amber-50/60 border border-amber-100 rounded-xl p-4 md:p-6">
                  <div className="flex gap-3 md:gap-4">
                    <div className="flex-shrink-0">
                      <div className="w-9 h-9 md:w-10 md:h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <svg className="w-4 h-4 md:w-5 md:h-5 text-amber-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                      </div>
                    </div>
                    <div>
                      <h4 className="text-xs md:text-sm font-semibold text-amber-800 uppercase tracking-wider mb-1">
                        {t("workDescription")}
                      </h4>
                      <p className="text-sm md:text-base text-stone-700 leading-relaxed">
                        {beforeDesc}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </section>
      )}

      {/* ═══════════════════════════════════════════════════════════════════ */}
      {/* APRÈS (AFTER) SECTION */}
      {/* ═══════════════════════════════════════════════════════════════════ */}
      {(project.afterImages && project.afterImages.length > 0 || afterDesc) && (
        <section className="py-6 md:py-16">
          <div className="container mx-auto px-2 md:px-4">
            <div className="max-w-6xl mx-auto bg-white/90 backdrop-blur-sm rounded-xl md:rounded-2xl shadow-xl border border-white/60 overflow-hidden">

              {/* Section Header */}
              <div className="relative px-4 pt-4 pb-2 md:px-10 md:pt-10 md:pb-4">
                <div className="absolute left-2 md:left-4 top-4 bottom-2 w-1 bg-gradient-to-b from-emerald-700 to-emerald-500 rounded-full" />

                <div className="pl-4 md:pl-6">
                  {/* Badge */}
                  <div className="inline-flex items-center gap-2 px-3 py-1.5 md:px-4 md:py-2 bg-emerald-50 border border-emerald-200 rounded-full mb-2 md:mb-4">
                    <svg className="w-3.5 h-3.5 md:w-4 md:h-4 text-emerald-700" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                    </svg>
                    <span className="text-emerald-800 font-semibold text-xs md:text-sm uppercase tracking-wider">
                      {t("finalResult")}
                    </span>
                  </div>

                  {/* Title */}
                  <h2 className="text-xl md:text-4xl font-bold text-stone-800 mb-1">
                    <span className="text-emerald-700">{t("after").split(' - ')[0]}</span>
                    {t("after").includes(' - ') && (
                      <span className="text-stone-400 font-normal"> — {t("after").split(' - ')[1]}</span>
                    )}
                  </h2>

                  {/* Decorative line */}
                  <div className="flex items-center gap-2 mt-2 md:mt-4">
                    <div className="h-1 w-12 md:w-16 bg-emerald-700 rounded-full" />
                    <div className="h-1 w-6 md:w-8 bg-emerald-500 rounded-full" />
                    <div className="h-1 w-3 md:w-4 bg-emerald-400 rounded-full" />
                  </div>
                </div>
              </div>

              {/* Image Slider — FIRST, near full-width on mobile */}
              {project.afterImages && project.afterImages.length > 0 && (
                <div className="px-1 py-2 md:px-8 md:py-6">
                  <ImageSliderGallery
                    images={project.afterImages}
                    title={`${title} - ${t("after")}`}
                  />
                </div>
              )}

              {/* Description Card — below images */}
              {afterDesc && (
                <div className="mx-3 mb-4 md:mx-10 md:mb-10 bg-emerald-50/60 border border-emerald-100 rounded-xl p-4 md:p-6">
                  <div className="flex gap-3 md:gap-4">
                    <div className="flex-shrink-0">
                      <div className="w-9 h-9 md:w-10 md:h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                        <svg className="w-4 h-4 md:w-5 md:h-5 text-emerald-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </div>
                    </div>
                    <div>
                      <h4 className="text-xs md:text-sm font-semibold text-emerald-800 uppercase tracking-wider mb-1">
                        {t("completedWork")}
                      </h4>
                      <p className="text-sm md:text-base text-stone-700 leading-relaxed">
                        {afterDesc}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </section>
      )}

      {/* ═══════════════════════════════════════════════════════════════════ */}
      {/* BOTTOM CTA */}
      {/* ═══════════════════════════════════════════════════════════════════ */}
      <CtaSection
        locale={locale}
        title={t("similarProject")}
        description={t("contactUs")}
        buttonText={t("requestQuote")}
      />
    </ThemeWrapper>
  );
}
